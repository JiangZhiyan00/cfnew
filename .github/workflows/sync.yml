name: Sync Upstream and Deploy to CF Worker

on:
  schedule:
    - cron: "34 4 * * *"   # åŒ—äº¬æ—¶é—´ æ¯å¤©12:34
  workflow_dispatch:       # å¯æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          set -e
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/byJoey/cfnew.git
          git fetch upstream main

      - name: Check for upstream changes
        id: check
        run: |
          set -e
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse upstream/main)
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "âœ… No new commits from upstream."
            echo "upstream_changed=false" >> $GITHUB_OUTPUT
          else
            echo "â¬†ï¸ Found new commits, syncing..."
            echo "upstream_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Sync upstream changes (safe file backup)
        if: steps.check.outputs.upstream_changed == 'true'
        run: |
          set -e
          echo "ðŸ”„ Syncing upstream changes but keeping local workflows..."
          
          git fetch upstream main
          git checkout main
          
          # ä¸´æ—¶å¤‡ä»½ workflow
          mkdir -p /tmp/workflows_backup
          cp -r .github/workflows/* /tmp/workflows_backup/ || true
          
          git reset --hard upstream/main
          
          # æ¢å¤ workflow
          mkdir -p .github/workflows
          cp -r /tmp/workflows_backup/* .github/workflows/ || true
          
          git add .github/workflows || true
          git commit -m "Preserve local workflows after upstream sync" || true

      - name: Push changes back to fork
        if: steps.check.outputs.upstream_changed == 'true'
        run: |
          set -e
          echo "âš™ï¸ Forcing push to fork..."
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main --force

      - name: Deploy to Cloudflare Worker
        if: steps.check.outputs.upstream_changed == 'true'
        run: |
          set -e
          FILE_PATH="å°‘å¹´ä½ ç›¸ä¿¡å…‰å—"

          if [ ! -f "$FILE_PATH" ]; then
            echo "âŒ Source file not found: $FILE_PATH"
            exit 1
          fi

          echo "âœ… Found source file: $FILE_PATH"
          
          cp "$FILE_PATH" index.js
          
          # åˆ›å»ºåŒ…å« KV ç»‘å®šå’ŒçŽ¯å¢ƒå˜é‡çš„ wrangler.toml
          cat > wrangler.toml <<EOF
          name = "${{ secrets.CF_WORKER_NAME }}"
          main = "index.js"
          compatibility_date = "$(date +%Y-%m-%d)"
          account_id = "${{ secrets.CF_ACCOUNT_ID }}"

          # KV å‘½åç©ºé—´ç»‘å®š
          [[kv_namespaces]]
          binding = "C"               # KV ç»‘å®šå˜é‡åç§°
          id = "${{ vars.FREE_KV_ID }}"  # KV å‘½åç©ºé—´ ID

          # çŽ¯å¢ƒå˜é‡
          [vars]
          u = "${{ vars.u }}"
          ev = "yes"  # å¯ç”¨ vless
          et = "yes"  # å¯ç”¨ trojan
          ex = "yes"  # å¯åŠ¨ xhttp
          EOF

          echo "ðŸš€ Deploying to Cloudflare Worker..."
          npx wrangler deploy --no-bundle
          
          rm index.js wrangler.toml
          echo "âœ… Deployment complete."

        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
